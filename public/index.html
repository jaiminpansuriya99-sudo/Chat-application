<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Real Chat App</title>
<style>
*{box-sizing:border-box;}
body{margin:0;font-family:'Segoe UI',sans-serif; display:flex; justify-content:center; align-items:center; height:100vh; background:url('/images/abc.png') no-repeat center center fixed; background-size:cover; transition:0.3s; color:#000;} 
body.dark{background:url('/images/abc.png') no-repeat center center fixed; color:#fff;}

#welcome-screen{background:#fff; border-radius:15px; padding:40px; text-align:center; box-shadow:0 4px 15px rgba(0,0,0,0.2);}
body.dark #welcome-screen{background:#2b2b2b; color:#fff;}
#welcome-screen h1{margin-bottom:20px;}
#welcome-screen button{padding:12px 25px;border:none;border-radius:25px;background:#007bff;color:#fff;font-size:16px;cursor:pointer;}
#welcome-screen button:hover{background:#0056b3;}

#chat-container{width:420px; height:600px; display:none; flex-direction:column; background:rgba(255,255,255,0.9); border-radius:15px; overflow:hidden; box-shadow:0 5px 15px rgba(0,0,0,0.3); backdrop-filter:blur(5px); position:relative;}
body.dark #chat-container{background:rgba(30,30,30,0.9);}


#chat-header{
    padding:15px 20px;
    font-weight:bold;
    font-size:18px;
    background:#007bff;
    color:#fff;
    text-align:center;
}
body.dark #chat-header{background:#0056b3;}

#dark-toggle{
    position:absolute;
    top:15px;
    right:15px;
    padding:8px;
    border:none;
    border-radius:50%;
    background:#333;
    color:#fff;
    cursor:pointer;
    z-index:10;
}
#dark-toggle:hover{background:#555;}

.messages{flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column;} 
.messages::-webkit-scrollbar{width:6px;} 
.messages::-webkit-scrollbar-thumb{background:#999; border-radius:10px;} 
.messages li{display:flex; align-items:flex-end; margin-bottom:12px; font-size:14px; max-width:80%; word-wrap:break-word; position:relative;} 
.messages li img{width:30px; height:30px; border-radius:50%; margin-right:8px;} 

.client{background:linear-gradient(135deg,#dcf8c6,#b8f0a6); align-self:flex-end; border-radius:20px 20px 0 20px; padding:10px 14px; position:relative;} 
.server{background:#fff; align-self:flex-start; border-radius:20px 20px 20px 0; padding:10px 14px; position:relative;} 
body.dark .server{background:#444; color:#fff;}

.tick{font-size:12px; margin-left:5px; color:gray;} 
.tick.read{color:#4fc3f7;} 

.input-container{display:flex; padding:10px; background:white; flex-shrink:0;} 
body.dark .input-container{background:#2b2b2b;} 

#msg{flex:1;padding:12px;border-radius:20px;border:1px solid #ccc; outline:none;font-size:14px;} 
body.dark #msg{background:#1e1e1e;color:#fff;border:1px solid #555;} 

#send-btn{padding:12px 20px; margin-left:8px; border:none;border-radius:20px;background:#0ecf95; color:#fff;font-size:14px;cursor:pointer;} 
#send-btn:hover{background:#05a377;}

@media(max-width:450px){#chat-container{width:95%;height:80vh;}}
</style>
</head>
<body>

<div id="welcome-screen">
    <h1>Welcome to Real Chat!</h1>
    <p>Connect and chat live with the server.</p>
    <button id="start-btn">Start New Chat</button>
</div>

<div id="chat-container">
    <div id="chat-header">Chat App</div>
    <button id="dark-toggle">ðŸŒ™</button>
    <ul class="messages" id="messages"></ul>
    <div class="input-container">
        <input id="msg" placeholder="Type a message..." autocomplete="off" />
        <button id="send-btn">Send</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const welcomeScreen = document.getElementById('welcome-screen');
const startBtn = document.getElementById('start-btn');
const chatContainer = document.getElementById('chat-container');
const messages = document.getElementById('messages');
const input = document.getElementById('msg');
const sendBtn = document.getElementById('send-btn');
const darkToggle = document.getElementById('dark-toggle');

const clientId = Date.now();

darkToggle.addEventListener('click', () => document.body.classList.toggle('dark'));

startBtn.addEventListener('click', () => {
    welcomeScreen.style.display = 'none';
    chatContainer.style.display = 'flex';
    messages.innerHTML = '';
    socket.emit('new chat');
});

function addMessage(msgObj){
    const li = document.createElement('li');
    li.className = msgObj.sender;

    if(msgObj.sender==='server'){
        const avatar = document.createElement('img');
        avatar.src='/images/server-avatar.png';
        li.appendChild(avatar);
    }

    // âœ… Only show text, never the object
    li.textContent = msgObj.text;

    if(msgObj.sender==='client'){
        const tick = document.createElement('span');
        tick.className = 'tick';
        tick.textContent = msgObj.status === 'read' ? 'âœ”âœ”' : 'âœ”';
        if(msgObj.status === 'read') tick.classList.add('read');
        li.appendChild(tick);

        if(msgObj.clientId !== clientId){
            socket.emit('message read', msgObj.id);
        }
    }

    messages.appendChild(li);
    messages.scrollTop = messages.scrollHeight;
}

sendBtn.addEventListener('click', () => {
    const text = input.value.trim();
    if(!text) return;

    const msgObj = {
        id: Date.now(),
        sender: 'client',
        text,
        status: 'sent',
        clientId
    };

    addMessage(msgObj);
    socket.emit('chat message', msgObj);
    input.value='';
});

input.addEventListener('keypress', e => { if(e.key==='Enter') sendBtn.click(); });

socket.on('new message', msgObj => {
    if(msgObj.sender === 'client' && msgObj.clientId === clientId) return;
    addMessage(msgObj);
});

socket.on('update status', ({id,status}) => {
    const items = messages.querySelectorAll('li.client');
    items.forEach(li=>{
        const tick = li.querySelector('.tick');
        if(tick && !tick.classList.contains('read')){
            if(status==='read'){ tick.classList.add('read'); tick.textContent='âœ”âœ”'; }
        }
    });
});

socket.on('chat history', history => {
    messages.innerHTML='';
    history.forEach(msgObj => addMessage(msgObj));
});
</script>
</body>
</html>
